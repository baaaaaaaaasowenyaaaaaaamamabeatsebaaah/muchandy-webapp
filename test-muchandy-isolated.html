<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MuchandyHero Isolated Test</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        background: #f5f5f5;
      }

      .test-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .test-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .test-button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .test-button:hover {
        background: #f0f0f0;
      }

      .test-button.primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .test-button.primary:hover {
        background: #2563eb;
      }

      .status {
        margin-top: 15px;
        padding: 10px;
        background: #e0f2fe;
        border: 1px solid #0ea5e9;
        border-radius: 4px;
        font-size: 14px;
      }

      .log {
        background: #1e293b;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .log-entry {
        margin-bottom: 5px;
      }

      .log-entry.error {
        color: #fca5a5;
      }

      .log-entry.success {
        color: #86efac;
      }

      .log-entry.warning {
        color: #fde047;
      }

      #hero-container {
        background: white;
        min-height: 600px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* Debug styles */
      .debug-overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10000;
      }
    </style>
  </head>
  <body>
    <div class="test-header">
      <h1>ðŸ§ª MuchandyHero Isolated Test</h1>
      <p>
        This page tests the MuchandyHero component in isolation to identify
        interaction issues.
      </p>

      <div class="test-controls">
        <button class="test-button primary" onclick="createHero()">
          Create MuchandyHero
        </button>
        <button class="test-button" onclick="analyzeHero()">
          Analyze Component
        </button>
        <button class="test-button" onclick="testInteractions()">
          Test Interactions
        </button>
        <button class="test-button" onclick="applyFixes()">Apply Fixes</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
      </div>

      <div class="status" id="status">Ready to test</div>

      <div class="log" id="log">
        <div class="log-entry">Test page initialized</div>
      </div>
    </div>

    <div id="hero-container"></div>

    <script type="module">
      // Import MuchandyHero from your library
      import {
        MuchandyHero,
        PhoneRepairForm,
        UsedPhonePriceForm,
        createElement,
      } from 'svarog-ui-core';

      // Import theme
      import muchandyTheme from '@svarog-ui/theme-muchandy';

      // Global test state
      window.testState = {
        hero: null,
        repairForm: null,
        buybackForm: null,
        apiService: null,
      };

      // Logging utility
      window.log = (message, type = 'info') => {
        const logEl = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;

        console.log(`[Test] ${message}`);
      };

      window.setStatus = (message) => {
        document.getElementById('status').textContent = message;
      };

      // Create mock API service
      window.createMockApiService = () => {
        return {
          fetchManufacturers: () => {
            log('API: Fetching manufacturers');
            return Promise.resolve([
              { id: '1', name: 'Apple' },
              { id: '2', name: 'Samsung' },
              { id: '3', name: 'Google' },
            ]);
          },

          fetchDevices: (manufacturerId) => {
            log(`API: Fetching devices for manufacturer ${manufacturerId}`);
            const devices = {
              1: [
                { id: '1', name: 'iPhone 15 Pro Max' },
                { id: '2', name: 'iPhone 15 Pro' },
                { id: '3', name: 'iPhone 15' },
              ],
              2: [
                { id: '4', name: 'Galaxy S24 Ultra' },
                { id: '5', name: 'Galaxy S24' },
              ],
              3: [
                { id: '6', name: 'Pixel 8 Pro' },
                { id: '7', name: 'Pixel 8' },
              ],
            };
            return Promise.resolve(devices[manufacturerId] || []);
          },

          fetchActions: (deviceId) => {
            log(`API: Fetching actions for device ${deviceId}`);
            return Promise.resolve([
              { id: '1', name: 'Display Reparatur' },
              { id: '2', name: 'Akku Tausch' },
              { id: '3', name: 'Kamera Reparatur' },
            ]);
          },

          fetchPrice: (actionId, deviceId) => {
            log(
              `API: Fetching price for action ${actionId}, device ${deviceId}`
            );
            return Promise.resolve({
              price: 29900,
              currency: 'â‚¬',
              formatted: '299,00 â‚¬',
              estimatedTime: '30-60 Min',
            });
          },

          fetchConditions: (deviceId) => {
            log(`API: Fetching conditions for device ${deviceId}`);
            return Promise.resolve([
              { id: '1', name: 'Wie Neu' },
              { id: '2', name: 'Gut' },
              { id: '3', name: 'Akzeptabel' },
            ]);
          },
        };
      };

      // Create MuchandyHero
      window.createHero = () => {
        try {
          log('Creating MuchandyHero component...', 'info');
          setStatus('Creating component...');

          // Apply theme
          if (!window.themeApplied) {
            muchandyTheme.apply();
            window.themeApplied = true;
            log('Applied Muchandy theme', 'success');
          }

          // Create API service
          const apiService = createMockApiService();
          window.testState.apiService = apiService;

          // Create forms
          log('Creating repair form...');
          const repairForm = PhoneRepairForm({
            service: apiService,
            onChange: (priceData) => {
              log(
                `Repair price changed: ${JSON.stringify(priceData)}`,
                'success'
              );
            },
            onSubmit: (formData) => {
              log(
                `Repair form submitted: ${JSON.stringify(formData)}`,
                'success'
              );
            },
          });
          window.testState.repairForm = repairForm;

          log('Creating buyback form...');
          const buybackForm = UsedPhonePriceForm({
            service: apiService,
            onChange: (priceData) => {
              log(
                `Buyback price changed: ${JSON.stringify(priceData)}`,
                'success'
              );
            },
            onSubmit: (formData) => {
              log(
                `Buyback form submitted: ${JSON.stringify(formData)}`,
                'success'
              );
            },
          });
          window.testState.buybackForm = buybackForm;

          // Create hero
          log('Creating MuchandyHero...');
          const hero = MuchandyHero({
            title: 'Test<br>MuchandyHero',
            subtitle: 'Click tabs and interact with forms',
            repairForm,
            buybackForm,
            defaultValue: 'repair',
            className: 'test-muchandy-hero',
          });
          window.testState.hero = hero;

          // Clear container and add hero
          const container = document.getElementById('hero-container');
          container.innerHTML = '';
          container.appendChild(hero.getElement());

          log('MuchandyHero created successfully!', 'success');
          setStatus('Component created - try clicking tabs and selects');

          // Add interaction listeners
          addInteractionListeners();
        } catch (error) {
          log(`Error creating hero: ${error.message}`, 'error');
          console.error(error);
          setStatus('Error creating component');
        }
      };

      // Add interaction listeners for debugging
      window.addInteractionListeners = () => {
        log('Adding debug interaction listeners...');

        const container = document.getElementById('hero-container');

        // Global click listener
        container.addEventListener(
          'click',
          (e) => {
            const target = e.target;
            const tagInfo = `${target.tagName}${target.className ? '.' + target.className : ''}`;
            log(`Click detected on: ${tagInfo}`, 'warning');

            // Check if it's a tab
            if (target.matches('[role="tab"], .svarog-tabs__tab')) {
              log('Tab clicked!', 'success');
            }

            // Check if it's a select
            if (target.matches('select, .svarog-select')) {
              log('Select clicked!', 'success');
            }
          },
          true
        ); // Use capture

        // Form change listener
        container.addEventListener(
          'change',
          (e) => {
            const target = e.target;
            log(
              `Change event on ${target.tagName}: ${target.value}`,
              'success'
            );
          },
          true
        );
      };

      // Analyze hero structure
      window.analyzeHero = () => {
        log('Analyzing MuchandyHero structure...', 'info');

        const hero = document.querySelector(
          '.muchandy-hero, .test-muchandy-hero, [class*="muchandy-hero"]'
        );
        if (!hero) {
          log('Hero element not found!', 'error');
          return;
        }

        log(`Hero found: ${hero.className}`);

        // Find tabs
        const tabs = hero.querySelectorAll('[role="tab"], .svarog-tabs__tab');
        log(`Tabs found: ${tabs.length}`);
        tabs.forEach((tab, i) => {
          const styles = window.getComputedStyle(tab);
          log(
            `  Tab ${i}: pointer-events=${styles.pointerEvents}, z-index=${styles.zIndex}`
          );
        });

        // Find selects
        const selects = hero.querySelectorAll('select');
        log(`Selects found: ${selects.length}`);
        selects.forEach((select, i) => {
          log(
            `  Select ${i}: ${select.options.length} options, disabled=${select.disabled}`
          );
        });

        // Find buttons
        const buttons = hero.querySelectorAll('button');
        log(`Buttons found: ${buttons.length}`);

        // Check for blocking elements
        const firstTab = tabs[0];
        if (firstTab) {
          const rect = firstTab.getBoundingClientRect();
          const topElement = document.elementFromPoint(
            rect.left + rect.width / 2,
            rect.top + rect.height / 2
          );
          if (topElement !== firstTab && !firstTab.contains(topElement)) {
            log(
              `First tab is blocked by: ${topElement.tagName}.${topElement.className}`,
              'error'
            );
          } else {
            log('First tab appears clickable', 'success');
          }
        }
      };

      // Test interactions programmatically
      window.testInteractions = async () => {
        log('Testing interactions programmatically...', 'info');

        const hero = document.querySelector(
          '.muchandy-hero, .test-muchandy-hero, [class*="muchandy-hero"]'
        );
        if (!hero) {
          log('Hero not found!', 'error');
          return;
        }

        // Test tab clicks
        const tabs = hero.querySelectorAll('[role="tab"], .svarog-tabs__tab');
        for (let i = 0; i < tabs.length; i++) {
          log(`Clicking tab ${i}...`);
          tabs[i].click();
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        // Test select
        const selects = hero.querySelectorAll('select');
        if (selects[0] && selects[0].options.length > 1) {
          log('Changing first select...');
          selects[0].selectedIndex = 1;
          selects[0].dispatchEvent(new Event('change', { bubbles: true }));
        }

        log('Interaction test complete', 'success');
      };

      // Apply fixes
      window.applyFixes = () => {
        log('Applying interaction fixes...', 'info');

        const style = document.createElement('style');
        style.textContent = `
                /* Force all interactive elements to be clickable */
                .muchandy-hero *,
                .test-muchandy-hero * {
                    pointer-events: auto !important;
                }
                
                .muchandy-hero::before,
                .muchandy-hero::after,
                .muchandy-hero *::before,
                .muchandy-hero *::after {
                    pointer-events: none !important;
                }
                
                .muchandy-hero button,
                .muchandy-hero select,
                .muchandy-hero [role="tab"],
                .muchandy-hero .svarog-tabs__tab {
                    position: relative !important;
                    z-index: 100 !important;
                    cursor: pointer !important;
                }
            `;
        document.head.appendChild(style);

        log('CSS fixes applied', 'success');

        // Force fix elements directly
        const hero = document.querySelector(
          '.muchandy-hero, .test-muchandy-hero'
        );
        if (hero) {
          const elements = hero.querySelectorAll(
            'button, select, [role="tab"]'
          );
          elements.forEach((el) => {
            el.style.pointerEvents = 'auto';
            el.style.cursor = 'pointer';
            el.style.position = 'relative';
            el.style.zIndex = '100';
          });
          log(`Fixed ${elements.length} elements directly`, 'success');
        }

        setStatus('Fixes applied - test interactions again');
      };

      // Clear log
      window.clearLog = () => {
        document.getElementById('log').innerHTML =
          '<div class="log-entry">Log cleared</div>';
      };

      // Make functions globally available
      window.createHero = createHero;
      window.analyzeHero = analyzeHero;
      window.testInteractions = testInteractions;
      window.applyFixes = applyFixes;
      window.clearLog = clearLog;

      // Auto-create hero on load
      log('Test page ready - click "Create MuchandyHero" to start', 'success');
    </script>
  </body>
</html>
